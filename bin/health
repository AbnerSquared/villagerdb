#!/usr/bin/env node

require('dotenv').config();

const fs = require('fs');
const path = require('path');
const urlHelper = require('../helpers/url');

/**
 * Report on any missing aspects of an item's image.
 * @param entityId
 * @param variationId
 */
function reportOnImage(entityId, variationId) {
    const output = [];

    const imageData = urlHelper.getEntityImageData(urlHelper.ITEM, entityId, variationId, false);
    if (!imageData.full) {
        output.push('Missing full image.');
    }
    if (!imageData.medium) {
        output.push('Missing medium image.');
    }
    if (!imageData.thumb) {
        output.push('Missing thumb image');
    }

    if (output.length > 0) {
        if (!variationId) {
            console.log(entityId + ':');
        } else {
            console.log(entityId + ' (' + variationId + '):');
        }

        for (let o of output) {
            console.log('\t' + o);
        }
    }
}

/**
 * Check items health.
 */
function itemHealthReport() {
    const files = fs.readdirSync(path.join('data', 'items'));
    for (let file of files) {
        const data = fs.readFileSync(path.join('data', 'items', file), 'utf8');
        const parsed = JSON.parse(data);

        // Check base image.
        reportOnImage(parsed.id);

        // Check variants - NH only
        if (parsed.games.nh && parsed.games.nh.variations) {
            for (let variationId of Object.keys(parsed.games.nh.variations)) {
                reportOnImage(parsed.id, variationId);
            }
        }

    }
}

if (process.argv.length !== 3) {
    console.error('Specify a command.');
    process.exit(1);
}

const command = process.argv[2];
if (command === 'items') {
    itemHealthReport();
} else {
    console.error('Invalid command: ' + command);
    process.exit(1);
}